---
import "../styles/globals.css";
import "../styles/theme.css";
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Athul Jith KS | Frontend Developer</title>
    <meta
      name="description"
      content="Frontend-focused full-stack portfolio of Athul Jith KS featuring React, Next.js, Astro, ERPNext integrations, and recent projects."
    />
    <script>
      (() => {
        const stored = localStorage.getItem("theme");
        const theme = stored ??
          (window.matchMedia("(prefers-color-scheme: dark)").matches
            ? "dark"
            : "light");
        document.documentElement.setAttribute("data-theme", theme);
      })();
    </script>
  </head>
  <body>
    <div id="scroll-progress" aria-hidden="true"></div>
    <slot />
    <script>
      (() => {
        const initMotion = () => {
          const main = document.querySelector("main");
          if (!main) return;

          const revealSelectors = [
            "main > section:not(#home)",
            ".aboutCard",
            ".experienceCard",
            ".projectCard",
            ".skillCard",
            ".softCard",
            ".educationCard",
            ".contactCard"
          ];

          const revealItems = document.querySelectorAll(revealSelectors.join(", "));
          revealItems.forEach((item, index) => {
            item.setAttribute("data-reveal", "");
            item.style.setProperty("--reveal-delay", `${(index % 6) * 70}ms`);
          });

          const revealObserver = new IntersectionObserver(
            (entries, observer) => {
              entries.forEach((entry) => {
                if (!entry.isIntersecting) return;
                entry.target.classList.add("is-visible");
                observer.unobserve(entry.target);
              });
            },
            {
              root: main,
              threshold: 0.16,
              rootMargin: "0px 0px -8% 0px"
            }
          );

          revealItems.forEach((item) => revealObserver.observe(item));

          const progressBar = document.getElementById("scroll-progress");
          const navLinks = Array.from(
            document.querySelectorAll("nav a[href^='#']")
          );
          const sections = Array.from(
            document.querySelectorAll("main > section[id]")
          );

          const setActiveLink = (id) => {
            navLinks.forEach((link) => {
              const href = link.getAttribute("href");
              const matches = href === `#${id}`;
              link.classList.toggle("active", matches);
              if (matches) {
                link.setAttribute("aria-current", "true");
              } else {
                link.removeAttribute("aria-current");
              }
            });
          };

          let ticking = false;
          const updateScrollUI = () => {
            const max = main.scrollHeight - main.clientHeight;
            const ratio = max > 0 ? main.scrollTop / max : 0;
            if (progressBar) {
              progressBar.style.transform = `scaleX(${ratio})`;
            }

            const target = main.scrollTop + main.clientHeight * 0.38;
            let activeId = "about";
            for (const section of sections) {
              if (section.id === "home") continue;
              if (section.offsetTop <= target) {
                activeId = section.id;
              }
            }
            setActiveLink(activeId);
            ticking = false;
          };

          const onScroll = () => {
            if (ticking) return;
            ticking = true;
            requestAnimationFrame(updateScrollUI);
          };

          main.addEventListener("scroll", onScroll, { passive: true });
          window.addEventListener("resize", onScroll);
          updateScrollUI();
        };

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", initMotion, {
            once: true
          });
        } else {
          initMotion();
        }
      })();
    </script>
  </body>
</html>
